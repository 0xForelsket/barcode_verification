<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor - Barcode Verification</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/style.css') }}?v=4.0">
</head>
<body>
    <header class="header">
        <div class="header-left">
            <span class="logo">‚¨°</span>
            <span class="title">Monitor</span>
        </div>
        <div class="header-right">
            <div class="shift-badge">
                <div class="stat">
                    <span class="value" id="shift-shippers">{{ shift.total_shippers }}</span>
                    <span class="label">ship</span>
                </div>
                <div class="stat">
                    <span class="value" id="shift-pieces">{{ shift.total_pieces }}</span>
                    <span class="label">pcs</span>
                </div>
                <div class="stat">
                    <span class="value" id="shift-jobs">{{ shift.jobs_completed }}</span>
                    <span class="label">jobs</span>
                </div>
            </div>
            <div class="clock" id="clock">00:00</div>
        </div>
    </header>

    <main class="main-content">
        <div class="page-header">
            <h1>üì∫ Remote Monitor</h1>
            <div class="nav-links">
                <a href="/" class="nav-link">‚Üê Operator</a>
                <a href="/history" class="nav-link">History</a>
            </div>
        </div>

        <div class="monitor-layout">
            <!-- Main Status -->
            <div class="monitor-main">
                <div class="monitor-status {{ 'idle' if not active_job else '' }}" id="main-status">
                    {% if active_job %}
                    <div class="status-label active">‚óè Active Job</div>
                    <div class="job-name" id="monitor-job-id">{{ active_job.job_id }}</div>

                    <div class="result-display" id="result-display">
                        <div class="result-status" id="result-text">WAITING</div>
                        <div class="result-barcode" id="result-barcode">{{ active_job.expected_barcode }}</div>
                    </div>

                    <div class="monitor-stats">
                        <div class="monitor-stat">
                            <div class="label">Shippers</div>
                            <div class="value" id="stat-total">{{ active_job.total_scans }}</div>
                        </div>
                        <div class="monitor-stat">
                            <div class="label">Pieces</div>
                            <div class="value" style="color:var(--primary)" id="stat-pieces">{{ active_job.total_pieces }}</div>
                        </div>
                        <div class="monitor-stat">
                            <div class="label">Rate</div>
                            <div class="value" id="stat-rate">{{ '%.0f' % active_job.pass_rate }}%</div>
                        </div>
                        <div class="monitor-stat">
                            <div class="label">This Hour</div>
                            <div class="value" style="color:var(--warning)" id="hourly-shippers">{{ active_job.scans_this_hour }}</div>
                        </div>
                        <div class="monitor-stat">
                            <div class="label">Failed</div>
                            <div class="value" style="color:var(--danger)" id="stat-fail">{{ active_job.fail_count }}</div>
                        </div>
                        <div class="monitor-stat">
                            <div class="label">Elapsed</div>
                            <div class="value" id="job-elapsed">{{ active_job.elapsed_formatted }}</div>
                        </div>
                    </div>
                    {% else %}
                    <div class="status-label">‚óã No Active Job</div>
                    <p style="color:var(--text-muted);margin-top:16px;">Waiting for operator...</p>
                    {% endif %}
                </div>
            </div>

            <!-- Sidebar -->
            <div class="monitor-sidebar">
                <div class="panel-box">
                    <div class="panel-header">
                        <span class="panel-title">Today's Shift</span>
                    </div>
                    <div class="panel-body">
                        <div class="stat-box" style="margin-bottom:8px;">
                            <div class="label">Total Shippers</div>
                            <div class="value" id="shift-total-shippers">{{ shift.total_shippers }}</div>
                        </div>
                        <div class="stat-box" style="margin-bottom:8px;">
                            <div class="label">Total Pieces</div>
                            <div class="value accent" id="shift-total-pieces">{{ shift.total_pieces }}</div>
                        </div>
                        <div class="stat-box">
                            <div class="label">Jobs Done</div>
                            <div class="value" id="shift-total-jobs">{{ shift.jobs_completed }}</div>
                        </div>
                    </div>
                </div>

                <div class="panel-box" style="flex:1;">
                    <div class="panel-header">
                        <span class="panel-title">Recent Jobs</span>
                    </div>
                    <div class="panel-body">
                        {% if recent_jobs %}
                        {% for job in recent_jobs[:6] %}
                        <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);">
                            <div>
                                <div style="font-weight:600;">{{ job.job_id }}</div>
                                <div style="font-size:11px;color:var(--text-muted);">{{ job.start_time.strftime('%H:%M') }} ¬∑ {{ job.total_scans }} shippers</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="color:{{ 'var(--success)' if job.pass_rate >= 99 else 'var(--warning)' if job.pass_rate >= 95 else 'var(--danger)' }}">{{ '%.0f' % job.pass_rate }}%</div>
                                <div style="font-size:11px;color:var(--text-muted);">{{ 'Active' if job.is_active else 'Done' }}</div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <p style="color:var(--text-muted);">No jobs today</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Clock
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString('en-US', { 
                hour12: false, hour: '2-digit', minute: '2-digit' 
            });
        }
        setInterval(updateClock, 1000);
        updateClock();

        // SSE
        const eventSource = new EventSource('/api/events');

        eventSource.addEventListener('scan', (e) => {
            const data = JSON.parse(e.data);
            const scan = data.scan;
            const job = data.job;

            const resultDisplay = document.getElementById('result-display');
            const resultText = document.getElementById('result-text');
            const resultBarcode = document.getElementById('result-barcode');

            if (resultDisplay) {
                resultDisplay.classList.remove('pass', 'fail');
                resultDisplay.classList.add(scan.status.toLowerCase());
                resultText.textContent = scan.status === 'PASS' ? '‚úì PASS' : '‚úó FAIL';
                resultBarcode.textContent = scan.barcode;
            }

            const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
            setEl('stat-total', job.total_scans);
            setEl('stat-pieces', job.total_pieces);
            setEl('stat-rate', Math.round(job.pass_rate) + '%');
            setEl('stat-fail', job.fail_count);
            setEl('hourly-shippers', job.scans_this_hour);
            setEl('job-elapsed', job.elapsed);
        });

        eventSource.addEventListener('job_started', () => location.reload());
        eventSource.addEventListener('job_ended', () => location.reload());
    </script>
</body>
</html>
